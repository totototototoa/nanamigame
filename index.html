<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>å“ˆå“ˆï¼SAIï¼ä½ ç ´é™¤ä¸äº†æˆ‘çš„è®°å½•çš„ï¼</title>
<style>
:root{ --frameW:322px; }
*{box-sizing:border-box}
html,body{
  margin:0;height:100%;
  background:#000;color:#0ff;font-family:'Courier New',monospace;
  overflow:hidden;display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding-top: env(safe-area-inset-top, 0);
  overscroll-behavior: contain;
}
h1#titleText{
  margin:10px 0 8px;font-size:1.8rem;letter-spacing:.5px;
  animation:neon 1.5s ease-in-out infinite alternate; text-align:center; width:100%;
}
@keyframes neon{
  from{color:#0ff;text-shadow:0 0 10px #0ff,0 0 24px #0ff,0 0 32px #ff0;}
  to  {color:#ff0;text-shadow:0 0  8px #f0f,0 0 20px #0ff,0 0 30px #ff0;}
}
.score{
  margin:6px 0 8px;
  font-size:0.95rem;
  text-shadow:0 0 6px #0ff;
  width:var(--frameW); text-align:center;
}
#gameArea{display:none;flex-direction:column;align-items:center;width:100%; overflow: visible;}
#frame{display:flex;flex-direction:column;align-items:center;gap:8px;width:var(--frameW); transform-origin: top center;}
#container{
  display:grid;grid-template-columns:200px 110px;grid-template-rows:auto auto;
  column-gap:12px;row-gap:10px;align-items:start;justify-content:center;
  width:var(--frameW);
}
canvas#game{
  grid-column:1;grid-row:1;background:#111;border-radius:8px;box-shadow:0 0 18px var(--glow,#0ff);
}
.sidebar{grid-column:2;grid-row:1 / span 2;display:flex;flex-direction:column;align-items:center;}
canvas#next{
  background:#111;width:75px;height:75px;border-radius:6px;box-shadow:0 0 10px var(--glow,#0ff);
}
#pauseButton,#restartButton,#bombButton{
  display:block;margin:6px auto;background:rgba(255,255,255,0.1);
  border:1px solid #0ff;border-radius:6px;color:#0ff;font-size:.9rem;padding:6px 12px;box-shadow:0 0 8px #0ff;
  width:100px;text-align:center;
}
#restartButton{display:none;}
#bombButton{display:none;}
.controls{
  grid-column:1;
  grid-row:2;
  display:flex;
  justify-content:center;
  align-items:center;
  width:100%;
  gap:16px;           /* é—´è·åŠ å¤§ */
  margin:10px auto 0;
  flex-wrap:wrap;     /* å°å±è‡ªåŠ¨æ¢è¡Œ */
}

.btn{
  background:rgba(0,255,255,0.1);
  border:1px solid #0ff;
  color:#0ff;
  border-radius:10px;
  padding:14px 18px;      /* æŒ‰é”®æ•´ä½“åŠ å¤§ */
  font-size:1.4rem;
  box-shadow:0 0 12px #0ff;
  min-width:60px;         /* ä¿è¯ç‚¹å‡»åŒºåŸŸå¤Ÿå®½ */
  min-height:60px;        /* é˜²è¯¯è§¦ */
  touch-action:none;
  user-select:none;
  -webkit-user-select:none;
  -webkit-touch-callout:none;
}
.btn:active{background:rgba(255,255,255,0.2);box-shadow:0 0 16px #ff0;}
.hrwrap{width:var(--frameW);margin:6px auto 0;border-top:1px solid #0ff;opacity:.8;}
#leaderboard{width:var(--frameW);margin:6px auto 0;text-align:left;}
#leaderboard h2{text-align:center;margin:4px 0;text-shadow:0 0 6px #0ff;font-size:1rem;}
#startBtn{
  background:rgba(0,255,255,0.15);border:1px solid #0ff;color:#0ff;border-radius:8px;
  padding:12px 24px;font-size:1.2rem;box-shadow:0 0 12px #0ff;cursor:pointer;transition:all .3s;
}
#startBtn:hover{background:rgba(255,255,255,0.1);transform:scale(1.05);}
.fadeIn{animation:fadeIn .8s ease forwards;}@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.fadeOut{animation:fadeOut .8s ease forwards;}@keyframes fadeOut{from{opacity:1}to{opacity:0}}
#modalOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);
  display:none;align-items:center;justify-content:center;z-index:10;
}
#modal{
  width:min(85vw,340px);background:rgba(10,20,25,.6);border:1px solid #0ff;border-radius:10px;
  box-shadow:0 0 20px #0ff,inset 0 0 10px rgba(0,255,255,.2);padding:14px;color:#0ff;text-align:center;
  transform:translateY(10px);opacity:0;transition:all .25s ease;
}
#modal.show{transform:translateY(0);opacity:1;}
#modal h3{margin:.2rem 0 .6rem;font-size:1rem;text-shadow:0 0 6px #0ff;}
#modal .actions{display:flex;gap:10px;justify-content:center;margin-top:10px;flex-wrap:wrap;}
#modal .actions button{
  background:rgba(0,255,255,.12);border:1px solid #0ff;color:#0ff;border-radius:8px;padding:6px 12px;cursor:pointer;
  box-shadow:0 0 8px #0ff;
}
#closeHint{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#000c;color:#0ff;z-index:9999}
#closeHint .box{border:1px solid #0ff;border-radius:12px;padding:16px 20px;background:#021319cc;box-shadow:0 0 18px #0ff;}
#closeHint a{color:#0ff;text-decoration:underline}
#starfield{position:fixed;inset:0;pointer-events:none;z-index:-1;}
/* ==== æ‰‹æœºç«¯å¸ƒå±€è¡¥ä¸ï¼ˆâ‰¤420pxï¼‰==== */
@media (max-width: 420px) {
  html, body {
    justify-content: flex-start;
  }
  #titleText {
    margin-top: calc(env(safe-area-inset-top, 0px) + 6px);
    font-size: 1.7rem;
  }
  #container{
    grid-template-columns: 200px 96px;
    column-gap: 8px;
    row-gap: 8px;
  }
  canvas#next { width:70px; height:70px; }
  #pauseButton,#restartButton,#bombButton { width:96px; }

  .controls{
    width: var(--frameW);
    gap: 10px;
    margin: 8px 0 0;
    flex-wrap: nowrap;
    justify-content: space-between;
  }
  .btn{
    min-width: 54px;
    min-height: 54px;
    padding: 10px 12px;
    font-size: 1.3rem;
    border-radius: 10px;
  }

  .hrwrap{ width:var(--frameW); margin: 6px auto 4px; }
  #leaderboard{ width:var(--frameW); margin: 4px auto 10px; }
  #leaderboard h2{ font-size: .95rem; margin: 2px 0 4px; }
}
  /* ==== æ¡Œé¢å…œåº•ï¼ˆâ‰¥800pxï¼‰ï¼šæ¢å¤åŸå§‹å¸ƒå±€ä¸ç½®ä¸­ ==== */
@media (min-width: 800px) {
  html, body { justify-content: center; }
  :root{ --frameW: 322px; }
  .controls{
    width: 200px;
    gap: 10px;
    margin: 0 auto;
    flex-wrap: nowrap;
    justify-content: center;
  }
  .btn{
    min-width: 36px;
    min-height: 36px;
    font-size: 1.2rem;
    border-radius: 6px;
  }
}
</style>
</head>
<body>
<canvas id="starfield"></canvas>

<h1 id="titleText">å“ˆå“ˆï¼SAIï¼ä½ ç ´é™¤ä¸äº†æˆ‘çš„è®°å½•çš„ï¼</h1>

<div id="scorePanel" class="score">
  åˆ†æ•°ï¼š<span id="score">0</span>ã€€æœ€é«˜ï¼š<span id="high">0</span>
</div>

<button id="startBtn">Start</button>

<div id="gameArea">
  <div id="frame">
    <div id="container">
      <canvas id="game" width="200" height="400"></canvas>

      <div class="sidebar">
        <canvas id="next" width="75" height="75"></canvas>
        <button id="pauseButton">â¸ æš‚åœ</button>
        <button id="restartButton">é‡æ–°å¼€å§‹</button>
        <button id="bombButton">ğŸ’£</button>
      </div>

      <div class="controls">
        <button class="btn" id="left">â—€</button>
        <button class="btn" id="rotate">âŸ³</button>
        <button class="btn" id="right">â–¶</button>
        <button class="btn" id="down">â–¼</button>
        <button class="btn" id="up" style="display:none;">â–²</button>
      </div>
    </div>

    <div class="hrwrap"></div>
    <div id="leaderboard">
      <h2>ğŸ† æ’è¡Œæ¦œ</h2>
      <div id="rankList"></div>
    </div>
  </div>
</div>

<div id="modalOverlay"><div id="modal">
  <h3 id="modalTitle">æç¤º</h3>
  <div id="modalText" style="font-size:.95rem;line-height:1.4;"></div>
  <div class="actions" id="modalActions"></div>
</div></div>

<div id="closeHint">
  <div class="box">
    <div style="margin-bottom:10px;">æµè§ˆå™¨é˜»æ­¢äº†è‡ªåŠ¨å…³é—­ã€‚ä½ å¯ä»¥ï¼š</div>
    <div>â‘  ç›´æ¥æ‰‹åŠ¨å…³é—­æ ‡ç­¾é¡µï¼›â‘¡ æˆ–ç‚¹å‡» <a href="about:blank" target="_self">è¿™é‡Œ</a> é€€åˆ°ç©ºç™½é¡µã€‚</div>
  </div>
</div>

<script>
/* ===== èƒŒæ™¯æ˜Ÿç©º ===== */
const starCanvas=document.getElementById('starfield');
const sctx=starCanvas.getContext('2d'); let stars=[], lastStarT=performance.now();
function resizeStars(){ const dpr=window.devicePixelRatio||1;
  starCanvas.width=Math.floor(innerWidth*dpr); starCanvas.height=Math.floor(innerHeight*dpr);
  sctx.setTransform(dpr,0,0,dpr,0,0);
}
function initStars(){
  const COLORS=['#0ff','#ff0','#f0f']; const N=120;
  stars=Array.from({length:N},(_,i)=>({x:Math.random()*innerWidth,y:Math.random()*innerHeight,
    vx:(i%3?0.04:0.02)*(Math.random()<0.5?-1:1), vy:(i%3?0.04:0.02)*(Math.random()<0.5?-1:1),
    r:0.8+(i%3)*0.4+Math.random()*0.5, color:COLORS[Math.floor(Math.random()*COLORS.length)],
    phase:Math.random()*Math.PI*2, tw:0.8+Math.random()*0.6}));
}
function tickStars(now){
  const dt=Math.min(40,now-lastStarT); lastStarT=now; sctx.clearRect(0,0,innerWidth,innerHeight);
  for(const s of stars){
    s.x+=s.vx*dt; s.y+=s.vy*dt;
    if(s.x<0) s.x=innerWidth; else if(s.x>innerWidth) s.x=0;
    if(s.y<0) s.y=innerHeight; else if(s.y>innerHeight) s.y=0;
    const a=0.35+0.65*(0.5+0.5*Math.sin(now*0.002+s.phase))*s.tw;
    sctx.globalAlpha=Math.max(0.35,Math.min(1,a));
    sctx.beginPath(); sctx.fillStyle=s.color; sctx.arc(s.x,s.y,s.r,0,Math.PI*2); sctx.fill();
  } requestAnimationFrame(tickStars);
}
addEventListener('resize',()=>{resizeStars();initStars();applyScale();});
resizeStars();initStars();requestAnimationFrame(tickStars);

/* ====== æ¸¸æˆå…¨å±€ ====== */
const startBtn=document.getElementById('startBtn');
const title=document.getElementById('titleText');
const gameArea=document.getElementById('gameArea');
const frameEl=document.getElementById('frame');
const game=document.getElementById('game'),ctx=game.getContext('2d');
const nextCanvas=document.getElementById('next'),nctx=nextCanvas.getContext('2d');
const pauseBtn=document.getElementById('pauseButton'),bombBtn=document.getElementById('bombButton'),
      upBtn=document.getElementById('up'), restartBtn=document.getElementById('restartButton');
const rankList=document.getElementById('rankList');
const modalOverlay=document.getElementById('modalOverlay'), modal=document.getElementById('modal');
const modalTitle=document.getElementById('modalTitle'), modalText=document.getElementById('modalText'), modalActions=document.getElementById('modalActions');
const closeHint=document.getElementById('closeHint');

/* === è‡ªé€‚åº”ç¼©æ”¾ === */
function getViewportSize() {
  const vv = window.visualViewport;
  return { w: Math.floor((vv ? vv.width  : window.innerWidth)),
           h: Math.floor((vv ? vv.height : window.innerHeight)) };
}
function applyScale(){
  const {w:vw, h:vh} = getViewportSize();

  // === æ¡Œé¢ï¼šæ¢å¤åŸæ ·ã€ä¸ç¼©æ”¾ ===
  if (vw >= 800) {
    frameEl.style.transform = 'none';
    // å±…ä¸­æ˜¾ç¤ºï¼ˆæ¡Œé¢æ›´å¥½çœ‹ï¼‰
    document.documentElement.style.setProperty('--frameW','322px');
    document.body.style.justifyContent = 'center';
    window.scrollTo(0, 0);
    return;
  }

  // === æ‰‹æœºï¼šæŒ‰å±å¹•è®¡ç®—ç¼©æ”¾ ===
  const titleEl = document.getElementById('titleText');
  const scoreElWrap = document.getElementById('scorePanel');

  frameEl.style.transform = 'none';
  const rect = frameEl.getBoundingClientRect();

  const titleH = titleEl ? titleEl.getBoundingClientRect().height : 0;
  const scoreH = scoreElWrap ? scoreElWrap.getBoundingClientRect().height : 0;
  const availW = Math.max(220, vw - 16);
  const availH = Math.max(260, vh - 16 - titleH - scoreH);

  const scaleW = availW / rect.width;
  const scaleH = availH / rect.height;
  const scale  = Math.max(0.40, Math.min(1, Math.min(scaleW, scaleH)));

  frameEl.style.transformOrigin = 'top center';
  frameEl.style.transform = `scale(${scale})`;

  document.body.style.justifyContent = 'flex-start';
  window.scrollTo(0, 0);
}
window.addEventListener('orientationchange', applyScale, {passive:true});
window.addEventListener('resize', applyScale, {passive:true});

/* åˆ†æ•°æ  */
let high = parseInt(localStorage.getItem('highscore') || '0');
const scoreEl = document.getElementById('score'); const highEl  = document.getElementById('high'); highEl.textContent = high;

const COLS=10,ROWS=20,BLOCK=20;
const COLORS=['#0ff','#f0f','#ff0','#0f0','#f80','#08f','#f44'];
const SHAPES=[ [[1,1,1,1]], [[1,1],[1,1]], [[0,1,0],[1,1,1]],
               [[1,0,0],[1,1,1]], [[0,0,1],[1,1,1]], [[1,1,0],[0,1,1]], [[0,1,1],[1,1,0]] ];

let grid,current,nextPiece,score=0;
let round=parseInt(sessionStorage.getItem('round')||'1');
let paused=false,locked=false,dropCounter=0,lastTime=0,dropInterval=500;
let unlockedUp=false,bombUses=0,maxBomb=10;
let smileEver = sessionStorage.getItem('smileEver')==='1';
let smileShownThisRound=false;
let showingFace=false;
let titleLocked = sessionStorage.getItem('titleLocked')==='1';
let firstFail = sessionStorage.getItem('firstFail')==='1';

/* â€”â€” å°±ç»ªæ€ä¸ç»Ÿä¸€æ£€æŸ¥ â€”â€” */
let gameReady = false;
const canPlay = () => gameReady && current;

/* é€ç¤¼æ–‡æ¡ˆï¼ˆâ€œå“¼å“¼â€¦â€ä¿ç•™åˆ°ä¸‹ä¸€å—è½åœ°ï¼‰ */
let giftBannerArmed=false;
let giftBannerConsumed=false;

/* è¾“å…¥å†·å´ï¼ˆå«å°±ç»ªåˆ¤æ–­ï¼‰ */
let inputCooldownUntil = 0;
function withCooldown(fn){
  if(!canPlay()) return;
  const now = performance.now();
  if(now < inputCooldownUntil) return;
  fn();
  inputCooldownUntil = now + 60;
}

/* ===== å•å®ä¾‹ RAF ===== */
let rafId=null;

/* ===== æ¨¡æ€é˜Ÿåˆ— ===== */
const modalQueue=[]; let modalOpen=false;
function clearModalQueue(){ modalQueue.length=0; }
function enqueueModal(def){ modalQueue.push(def); if(!modalOpen) showNextModal(); }
function showNextModal(){
  if(modalOpen) return; const def = modalQueue.shift(); if(!def) return; modalOpen=true;
  modalTitle.textContent=def.title||'æç¤º'; modalText.innerHTML=def.text||''; modalActions.innerHTML='';
  (def.buttons||[{label:'ç¡®å®š'}]).forEach(b=>{
    const btn=document.createElement('button'); btn.className='btn'; btn.textContent=b.label||'ç¡®å®š';
    btn.onclick=()=>{ hideModal(); if(b.onClick) b.onClick(); }; modalActions.appendChild(btn);
  });
  modalOverlay.style.display='flex'; requestAnimationFrame(()=>modal.classList.add('show'));
}
function hideModal(){
  modal.classList.remove('show');
  setTimeout(()=>{ modalOverlay.style.display='none'; modalOpen=false; showNextModal(); },200);
}

/* ===== ç½‘æ ¼ä¸æ–¹å— ===== */
function resetGrid(){grid=Array.from({length:ROWS},()=>Array(COLS).fill(0));}
function drawBlock(x,y,c){ctx.fillStyle=c;ctx.fillRect(x*BLOCK+1,y*BLOCK+1,BLOCK-2,BLOCK-2);}
function newPiece(){
  const id = Math.floor(Math.random() * SHAPES.length);
  const base = SHAPES[id].map(r => r.slice());
  return {
    id,                       // æ–°å¢ï¼šå½¢çŠ¶ç¼–å·ï¼ˆ0..6ï¼‰
    base,
    shape: base.map(r => r.slice()),
    color: COLORS[id],
    x: 3, y: 0,
    rot: 0, mir: 0,
    phase: 0                  // æ–°å¢ï¼šZ/S ä¸“ç”¨ 0..3 æ—‹è½¬é˜¶æ®µ
  };
}
function collide(p=current){
  for(let y=0;y<p.shape.length;y++){
    for(let x=0;x<p.shape[y].length;x++){
      if(!p.shape[y][x]) continue;
      const nx = p.x + x, ny = p.y + y;
      if (nx < 0 || nx >= COLS || ny >= ROWS) return true;
      if (ny >= 0 && grid[ny][nx]) return true;
    }
  }
  return false;
}
function merge(){ current.shape.forEach((r,y)=>r.forEach((v,x)=>{ if(v) grid[current.y+y][current.x+x]=current.color; })); }

/* ===== æ—‹è½¬ & é•œåƒï¼ˆå¸¦å¢™è¸¢ï¼‰ ===== */
function rot90(s){return s[0].map((_,i)=>s.map(r=>r[i])).reverse();}
function mirrorH(s){return s.map(r=>r.slice().reverse());}
function buildShape(base,rot,mir){ let s=base.map(r=>r.slice()); for(let i=0;i<rot;i++) s=rot90(s); if(mir) s=mirrorH(s); return s; }
const KICKS = [
  [0,0],[1,0],[-1,0],[2,0],[-2,0],
  [0,-1],[0,-2],[1,-1],[-1,-1]
];
function tryTransform(newRot,newMir){
  const prev={x:current.x,y:current.y,shape:current.shape,rot:current.rot,mir:current.mir};
  current.shape=buildShape(current.base,newRot,newMir);
  for(const [dx,dy] of KICKS){
    current.x=prev.x+dx; current.y=prev.y+dy;
    if(!collide()){ current.rot=newRot; current.mir=newMir; return true; }
  }
  Object.assign(current,prev); return false;
}
function doRotate(){
  if(!canPlay()) return;
  if(paused||locked||showingFace) return;

  // Z(6)/S(5)ï¼šæŠŠé•œåƒç¼–è¿›æ—‹è½¬å¾ªç¯ï¼Œå½¢æˆ 4 é˜¶æ®µ
  if (current.id === 5 || current.id === 6) {
    const map = [[0,0],[1,0],[0,1],[1,1]]; // [rot, mir]
    let phase = (current.phase ?? 0) + 1;
    if (phase > 3) phase = 0;
    const [r,m] = map[phase];
    if (tryTransform(r, m)) current.phase = phase;
    return;
  }

  // å…¶ä»–å½¢çŠ¶æŒ‰æ­£å¸¸ 0â†’1â†’2â†’3
  withCooldown(()=>{
    let r = (current.rot + 1) & 3;
    tryTransform(r, current.mir);
  });
}

/* âœ… æ–°å¢ï¼šé•œåƒå‡½æ•°ï¼ˆç¬¬ä¸‰æ­¥ï¼‰ */
function doMirror(){
  if(!canPlay()) return;
  if(paused||locked||showingFace) return;

  withCooldown(()=>{
    const newMir = current.mir ? 0 : 1;
    if (tryTransform(current.rot, newMir)) {
      // è‹¥æ˜¯ Z/Sï¼ŒæŠŠå½“å‰ (rot,mir) æ˜ å°„å› phaseï¼Œä¿æŒ 4 ç›¸ä½å¾ªç¯æ­£ç¡®
      if (current.id === 5 || current.id === 6) {
        const map = [[0,0],[1,0],[0,1],[1,1]];
        const found = map.findIndex(([r,m]) => r===current.rot && m===current.mir);
        current.phase = (found >= 0 ? found : 0);
      }
    }
  });
}

/* ===== ç»˜åˆ¶ ===== */
function draw(){
  ctx.fillStyle='#111';ctx.fillRect(0,0,game.width,game.height);
  if(grid) grid.forEach((r,y)=>r.forEach((v,x)=>v&&drawBlock(x,y,v)));
  if(!showingFace && current){
    current.shape.forEach((r,y)=>r.forEach((v,x)=>v&&drawBlock(current.x+x,current.y+y,current.color)));
  }
}
function drawNext(){
  nctx.fillStyle='#111';nctx.fillRect(0,0,75,75);
  if(showingFace || !nextPiece) return;
  const shap=buildShape(nextPiece.base,0,0);
  const sw=shap[0].length, sh=shap.length, ox=(75-(sw*16))/2, oy=(75-(sh*16))/2;
  shap.forEach((r,y)=>r.forEach((v,x)=>{ if(v){nctx.fillStyle=nextPiece.color;nctx.fillRect(ox+x*16+1,oy+y*16+1,14,14);} }));
}

/* ===== æ¶ˆè¡Œä¸ä¸‹è½ ===== */
function clearLines(){
  let lines=0;
  for(let y=ROWS-1;y>=0;y--){
    if(grid[y].every(v=>v!==0)){ grid.splice(y,1);grid.unshift(Array(COLS).fill(0));lines++;y++; }
  }
  if(lines>0){ score+=lines*10; updateScore(); }
}
function drop(){
  if(!canPlay()) return;
  if(paused||locked||showingFace)return;
  current.y++;
  if(collide()){
    current.y--;
    merge();clearLines();

// æ–¹å—è½åœ°ï¼šå¦‚â€œå“¼å“¼â€¦â€å¤„äºä¿æŒæ€ â†’ æ— æ¡ä»¶å¤ä½ï¼ˆé¿å…è·¨è¿‡ 100 åä»ç„¶æ‚¬æŒ‚ï¼‰
if (giftBannerArmed) {
  giftBannerArmed = false;
  giftBannerConsumed = true;
  refreshLeaderNameByScore();   // è®©ä¼˜å…ˆçº§é€»è¾‘ç»Ÿä¸€ç”Ÿæ•ˆ
  updateLeaderboard();
}

    current=nextPiece;nextPiece=newPiece();drawNext();
    if(collide())return gameOver();
  }
  dropCounter=0;
}

/* ===== æ’è¡Œæ¦œä¸è®¡åˆ† ===== */
let leaderboard=[{name:'ä¸ƒæµ·é¾™æ°´',score:10},{name:'Player',score:0}];
function stackedRows(){return grid.filter(r=>r.some(v=>v!==0)).length;}
function refreshLeaderNameByScore(){
  if (giftBannerArmed) {
    leaderboard[0].name = 'å“¼å“¼ã€ä½ çš„åŠªåŠ›æˆ‘çœ‹åˆ°äº†ï¼Œè¿™ä¸ªæŠ€èƒ½å°±é€ç»™ä½ å§ï¼';
  } else if (!giftBannerConsumed && score >= 50 && score < 100) {
    leaderboard[0].name = 'å“¼å“¼ã€ä½ çš„åŠªåŠ›æˆ‘çœ‹åˆ°äº†ï¼Œè¿™ä¸ªæŠ€èƒ½å°±é€ç»™ä½ å§ï¼';
    giftBannerArmed = true;
  } else if (stackedRows() >= 5) {
    leaderboard[0].name = 'è¯•è¯•è¿™ä¸ªä¸ç”¨è°¢ï¼';
  } else {
    leaderboard[0].name = 'ä¸ƒæµ·é¾™æ°´';
  }
}
function updateLeaderboard(){
  leaderboard[0].score = smileEver ? 1314 : score+10;
  leaderboard[1].score = score;
  const disp = [...leaderboard].sort((a,b)=>b.score-a.score);
  rankList.innerHTML = disp.map((p,i)=>`${i+1}. ${p.name} - ${p.score}`).join('<br>');
}
function updateScore(){
  scoreEl.textContent = score;
  if (score > high) { high = score; localStorage.setItem('highscore', String(high)); highEl.textContent = high; }
  if (score >= 50 && !unlockedUp) { unlockedUp = true; upBtn.style.display = 'inline-block'; }
  refreshLeaderNameByScore(); updateLeaderboard();

  if(!smileEver && !smileShownThisRound && score>=520){
    smileShownThisRound=true;
    const usedTen = bombUses>=10;
    showSmilePreview(usedTen);
  }
}

/* ===== ç‚¸å¼¹ï¼šâ‰¥5è¡Œå‡ºç°ï¼Œ+50ï¼Œæœ€å¤š10æ¬¡ ===== */
function refreshBombVisibility(){
  const show = (stackedRows()>=5 && bombUses<maxBomb);
  bombBtn.style.display = show ? 'block' : 'none';
  refreshLeaderNameByScore(); updateLeaderboard();
}
bombBtn.onclick=()=>{
  if(!canPlay()) return;
  if(paused||locked||showingFace)return;
  if(bombUses>=maxBomb||stackedRows()<5)return;
  bombUses++;
  grid.splice(ROWS-5,5); for(let i=0;i<5;i++) grid.unshift(Array(COLS).fill(0));
  score+=50; refreshBombVisibility(); updateScore(); draw();
};

/* ===== è§¦æ§/é”®ç›˜è¾“å…¥ï¼ˆç‚¹å‡»ä¸€æ­¥ï¼›é•¿æŒ‰è¿å‘ï¼‰ ===== */
function pressRepeat(el, onFire, {initialDelay=280, repeatEvery=180} = {}) {
  let timer = null, repeater = null;
  const fireOnce = () => withCooldown(onFire);
  const start = (ev) => {
    ev.preventDefault(); ev.stopPropagation();
    fireOnce();
    timer = setTimeout(() => { repeater = setInterval(fireOnce, repeatEvery); }, initialDelay);
  };
  const end = (ev) => {
    if (ev) { ev.preventDefault(); ev.stopPropagation(); }
    clearTimeout(timer); timer = null;
    if (repeater) { clearInterval(repeater); repeater = null; }
  };
  el.style.touchAction = 'none';
  el.addEventListener('pointerdown', start, {passive:false});
  el.addEventListener('pointerup', end, {passive:false});
  el.addEventListener('pointerleave', end, {passive:false});
  el.addEventListener('pointercancel', end, {passive:false});
  el.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); fireOnce(); }, {passive:false});
}
const btnLeft=document.getElementById('left');
const btnRight=document.getElementById('right');
const btnDown=document.getElementById('down');
const btnUp=document.getElementById('up');
pressRepeat(btnLeft,  ()=>{ if(!canPlay()) return; if(paused||locked||showingFace)return; current.x--; if(collide()) current.x++; });
pressRepeat(btnRight, ()=>{ if(!canPlay()) return; if(paused||locked||showingFace)return; current.x++; if(collide()) current.x--; });
pressRepeat(btnDown,  ()=>{ if(!canPlay()) return; if(paused||locked||showingFace)return; drop(); });
// â–² å‘ä¸ŠæŒ‰é’®ï¼šåªåœ¨è§£é”åå¯ç”¨ï¼Œé˜²æ­¢è¶Šç•Œ
pressRepeat(btnUp, ()=>{
  if(!canPlay()) return;
  if(paused || locked || showingFace || !unlockedUp) return;
  current.y = Math.max(0, current.y - 1);
});

/* æ—‹è½¬æŒ‰é’®ï¼šçŸ­æŒ‰=æ—‹è½¬ï¼›é•¿æŒ‰â‰¥350ms=é•œåƒä¸€æ¬¡ */
const rotateBtn=document.getElementById('rotate');
let rotTimer=null, rotDidLong=false;
rotateBtn.addEventListener('pointerdown', e=>{
  e.preventDefault(); e.stopPropagation();
  rotDidLong=false;
  rotTimer=setTimeout(()=>{ rotDidLong=true; doMirror(); }, 350);
},{passive:false});
rotateBtn.addEventListener('pointerup', e=>{
  e.preventDefault(); e.stopPropagation();
  clearTimeout(rotTimer);
  if(!rotDidLong) doRotate();
},{passive:false});
rotateBtn.addEventListener('pointercancel', ()=>{ clearTimeout(rotTimer); });
/* ===== é”®ç›˜æ§åˆ¶ï¼šæ–¹å‘é”® + WASD + ç©ºæ ¼ + å¯é€‰ä¸Šç§» ===== */
const keyMap = {
  left:  ['ArrowLeft','a','A','h','H'],
  right: ['ArrowRight','d','D','l','L'],
  down:  ['ArrowDown','s','S','j','J'],
  rotate:['ArrowUp','w','W',' '],      // æ—‹è½¬ï¼šâ†‘ / W / ç©ºæ ¼
  up1:   ['e','E','PageUp']            // ä¸Šç§»ä¸€æ ¼ï¼šE / PageUpï¼ˆéœ€è§£é”ï¼‰
};

document.addEventListener('keydown', (e)=>{
  if(!canPlay()) return;

  // é¿å…é¡µé¢æ»šåŠ¨æˆ–ç©ºæ ¼è§¦å‘æŒ‰é’®èšç„¦
  if (['ArrowUp','ArrowDown',' '].includes(e.key)) e.preventDefault();

  if (keyMap.left.includes(e.key)) {
    withCooldown(()=>{ current.x--; if (collide()) current.x++; });
  } else if (keyMap.right.includes(e.key)) {
    withCooldown(()=>{ current.x++; if (collide()) current.x--; });
  } else if (keyMap.down.includes(e.key)) {
    withCooldown(()=> drop());
  } else if (keyMap.rotate.includes(e.key)) {
    withCooldown(()=> doRotate());
  } else if (keyMap.up1.includes(e.key)) {
    withCooldown(()=>{
      if (unlockedUp && !paused && !locked && !showingFace) {
        current.y = Math.max(0, current.y - 1); // é¡¶éƒ¨ä¸è¶Šç•Œ
      }
    });
  } else if (e.key === 'q' || e.key === 'Q') {
    // å¯é€‰ï¼šQ=é•œåƒä¸€æ¬¡
    withCooldown(()=> doMirror());
  }
});

/* ===== æš‚åœä¸é‡æ–°å¼€å§‹ ===== */
pauseBtn.onclick=()=>{ if(!canPlay()) return; paused=!paused;pauseBtn.textContent=paused?'â–¶ ç»§ç»­':'â¸ æš‚åœ';if(!paused)update();};
restartBtn.onclick = ()=>{ nextRound(); };

/* ===== è¡¨æƒ…è’™ç‰ˆï¼ˆ0=ç»˜åˆ¶ï¼Œ1=é•‚ç©ºï¼‰ ===== */
const SMILE_MASK = [
  "0000000000","0000000000","0011001100","0101001010",
  "0000000000","0100110010","0011111100","0001111000","0000000000"
];
const CRY_MASK = [
  "0000000000","0000000000","0011001100","0011001100","0100000010",
  "0000110000","0001001000","0000000000","0000000000"
];
function drawFaceMask(mask, color){
  const rowStart = Math.max(0, ROWS - mask.length);
  resetGrid();
  for(let y=0;y<mask.length;y++)
    for(let x=0;x<10;x++)
      if(mask[y][x]==='0') grid[rowStart+y][x]=color;
  showingFace=true; locked=true; bombBtn.style.display='none'; restartBtn.style.display='block';
  draw(); nctx.clearRect(0,0,75,75);
}

/* â€”â€” ç¬‘è„¸é¢„è§ˆï¼š1.8s â€”â€” */
function showSmilePreview(usedTen){
  gameReady = false;
  drawFaceMask(SMILE_MASK,'#ff8c00'); // å—ç“œæ©™
  setTimeout(()=>{
    clearModalQueue(); modalOverlay.style.display='none'; modalOpen=false;
    enqueueModal({
      title:'æç¤º',
      text: usedTen ? 'å“ˆå“ˆï¼æ²¡æƒ³åˆ°è¿™é‡Œæœ‰éšè—æ·å¾„å§ï¼' : 'è¿™æ˜¯è¿™ä¸ªæ¸¸æˆçš„å”¯ä¸€å…³å¡ï¼Œæ­å–œé€šå…³ï¼æœ€å‰å®³çš„ç¨‹åºå‘˜ï¼',
      buttons:[{label: usedTen ? 'è¿™å…¶å®æ˜¯æˆ‘æµ‹è¯•æ—¶ç•™çš„åæ‰‹ï¼' : 'ç»§ç»­', onClick:()=> nextRound()}]
    });
    smileEver=true; sessionStorage.setItem('smileEver','1'); updateLeaderboard();
  },1800);
}

/* â€”â€” å“­è„¸é¢„è§ˆï¼š1.8s â€”â€” */
function showCryPreview(){
  gameReady = false;
  drawFaceMask(CRY_MASK,'#002fa7'); // å…‹è±å› è“
  setTimeout(()=>{
    clearModalQueue(); modalOverlay.style.display='none'; modalOpen=false;
    enqueueModal({
      title:'æç¤º',
      text:'è¿™æ ·å•Šâ€¦â€¦',
      buttons:[
        {label:'ï¼ˆçŠ¹è±«ï¼‰', onClick:()=> nextRound()},
        {label:'ï¼ˆåšæŒç¦»å¼€ï¼‰', onClick:()=> tryClose()}
      ]
    });
  },1800);
}

/* ===== å¤±è´¥ & ç¦»å¼€é€»è¾‘ + 1314 å½©è›‹ ===== */
function proceedGameOver(){
  if (!firstFail) {
    firstFail = true; sessionStorage.setItem('firstFail','1');
    enqueueModal({
      title:'æç¤º', text:'å“ˆå“ˆï¼æˆ‘å¯ä¸ä¼šè¿™ä¹ˆè½»æ˜“æ”¾ä½ ç¦»å¼€ï¼ç»§ç»­å§ï¼',
      buttons:[{label:'æ˜¯', onClick:()=> nextRound()},
               {label:'æ˜¯', onClick:()=> nextRound()}]
    });
    return;
  }
  enqueueModal({
    title:'æç¤º',
    text:'æ¥ï¼ç»§ç»­ï¼',
    buttons:[
      {label:'ç»§ç»­', onClick:()=> nextRound()},
      {label:'ç¦»å¼€', onClick:()=> startLeaveFlow()}
    ]
  });
}
function gameOver(){
  locked = true; bombBtn.style.display='none';
  if (score > 1314 && sessionStorage.getItem('ultraPlayShown') !== '1') {
    sessionStorage.setItem('ultraPlayShown','1');
    enqueueModal({
      title:'æç¤º',
      text:'SAIèƒ½é™ªæˆ‘ç©è¿™ä¹ˆä¹…ï¼Œæˆ‘çœŸçš„å¾ˆé«˜å…´',
      buttons:[{label:'å—¯', onClick:()=> proceedGameOver()}]
    });
    return;
  }
  proceedGameOver();
}
function startLeaveFlow(){ askLeaveStep(0); }
function askLeaveStep(step){
  const texts = ['çœŸçš„è¦ç¦»å¼€å—ï¼Ÿ','çœŸçš„çœŸçš„è¦ç¦»å¼€å—ï¼Ÿ','æœ€åä¸€æ¬¡ç¡®è®¤ï¼šçœŸçš„ä¸å’Œæˆ‘ç»§ç»­ç©äº†å—ï¼Ÿ'];
  if(step>=3){
    titleLocked = true; sessionStorage.setItem('titleLocked','1');
    clearModalQueue(); showCryPreview(); return;
  }
  enqueueModal({
    title:'æç¤º', text:texts[step],
    buttons:[
      {label:'æ˜¯', onClick:()=> askLeaveStep(step+1) },
      {label:'å¦', onClick:()=> { clearModalQueue(); nextRound(); } }
    ]
  });
}

/* ===== å…³é—­é¡µé¢ ===== */
function tryClose(){
  window.open('','_self'); window.close();
  setTimeout(()=>{
    try{ if(!document.hidden){ location.href='about:blank'; } }catch(e){}
    setTimeout(()=>{ document.getElementById('closeHint').style.display='flex'; },250);
  },150);
}

/* ===== å›åˆ/æ ‡é¢˜/å¯åŠ¨ ===== */
function changeGlowColor(){
  const c=['#0ff','#f0f','#ff0','#0f0','#08f','#f44'];
  document.documentElement.style.setProperty('--glow',c[Math.floor(Math.random()*c.length)]);
}
function changeTitleByRound(){
  if(titleLocked){ title.textContent='ä¸€ç›´ä¸€ç›´å’Œæˆ‘ç©å§SAIï¼'; applyScale(); return; }
  const t=[
    "å“ˆå“ˆï¼SAIï¼ä½ ç ´é™¤ä¸äº†æˆ‘çš„è®°å½•çš„ï¼",
    "æ¥å§ï¼SAIï¼ç»§ç»­æŒ‘æˆ˜å§ï¼",
    "è¿˜è¦ç»§ç»­å—ï¼Œæ²¡æœ‰å½©è›‹äº†",
    "å¥½ï¼SAIæƒ³å’Œæˆ‘ç»§ç»­ç©å°±ç»§ç»­å§ï¼",
    "ä¸€ç›´ä¸€ç›´å’Œæˆ‘ç©å§SAIï¼",
    "å“ˆå“ˆï¼SAIï¼ä½ ç ´é™¤ä¸äº†æˆ‘çš„è®°å½•çš„ï¼"
  ]; title.textContent=t[round-1];
  applyScale();
}
function resetUIStable(){
  restartBtn.style.display='none'; bombBtn.style.display='none';
  upBtn.style.display = unlockedUp ? 'inline-block' : 'none';
  document.documentElement.style.setProperty('--glow','#0ff'); changeGlowColor();
  giftBannerArmed=false;
}
function nextRound(){
  if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
  clearModalQueue(); modalOverlay.style.display='none'; modalOpen=false;
  gameReady = false;

  if(!titleLocked){
    if (round === 2 && !sessionStorage.getItem('title2Held')) {
      sessionStorage.setItem('title2Held', '1');
    } else {
      round++; 
      if (round > 6) round = 1;
      if (round === 5) { titleLocked = true; sessionStorage.setItem('titleLocked','1'); }
    }
  }
  sessionStorage.setItem('round',round); changeTitleByRound(); applyScale();

  showingFace=false; locked=false; paused=false;
  bombUses=0; unlockedUp=false; smileShownThisRound=false;
  upBtn.style.display='none'; resetGrid(); score=0;
  giftBannerConsumed = false; giftBannerArmed = false;

  current=newPiece(); nextPiece=newPiece(); drawNext(); draw();
  updateScore(); refreshBombVisibility(); resetUIStable();

  gameReady = true;
  lastTime=performance.now(); dropCounter=0; update();
}
function update(t=0){
  if(paused||locked||showingFace){ if(rafId){ cancelAnimationFrame(rafId); rafId=null; } return; }
  const d=t-lastTime; lastTime=t; dropCounter+=d; if(dropCounter>dropInterval) drop();
  draw(); refreshBombVisibility(); rafId=requestAnimationFrame(update);
}
function initGame(){
  changeTitleByRound();changeGlowColor();resetGrid();score=0;
  current=newPiece();nextPiece=newPiece();drawNext();updateLeaderboard();refreshBombVisibility();update();updateScore();
  applyScale();
  gameReady = true;
}
sessionStorage.removeItem('title2Held');
sessionStorage.removeItem('ultraPlayShown');
function startGame(){
  gameReady = false;
  sessionStorage.removeItem('title2Held');
  sessionStorage.removeItem('ultraPlayShown');
  startBtn.classList.add('fadeOut');
  setTimeout(()=>{
    startBtn.style.display='none';
    gameArea.style.display='flex';
    gameArea.classList.add('fadeIn');
    applyScale();
    initGame();
  },700);
}
startBtn.onclick=startGame;
// ğŸŒŒ ä¿®å¤ç§»åŠ¨ç«¯æ˜Ÿç©ºåœ¨æ–¹å‘æˆ–è¾“å…¥å˜åŒ–åå¶å°”ä¸é‡ç»˜çš„é—®é¢˜
if (window.visualViewport) {
  visualViewport.addEventListener('resize', () => {
    resizeStars();
    initStars();
    requestAnimationFrame(tickStars);
  });
}
</script>
</body>
</html>






